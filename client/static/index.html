<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TonightSky v1.0</title>
    <link rel="stylesheet" href="./css/styles.css">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dateField = document.getElementById('date');
            const timeField = document.getElementById('local_time');
            
            if (!dateField.value) {
                const today = new Date().toISOString().split('T')[0];
                dateField.value = today;
            }
            
            addResizers();
            updateLST();  // Initial LST calculation
            dateField.addEventListener('input', updateLST);
            timeField.addEventListener('input', updateLST);
        });

        async function updateLST() {
            const longitude = document.getElementById('longitude').value;
            const date = document.getElementById('date').value;
            const local_time = document.getElementById('local_time').value;
            const timezone = document.getElementById('timezone').value;

            if (!longitude || !date || !local_time || !timezone) return;  // Ensure all inputs are filled

            try {
                const response = await fetch('http://127.0.0.1:5000/api/calculate_lst', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ longitude, date, local_time, timezone })
                });

                if (!response.ok) throw new Error('Failed to calculate LST');
                
                const data = await response.json();
                document.getElementById('lst_display').textContent = data.LST;
            } catch (error) {
                console.error("Error fetching LST:", error);
            }
        }

        async function listObjects() {
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const date = document.getElementById('date').value;
            const local_time = document.getElementById('local_time').value;
            const timezone = document.getElementById('timezone').value;
            const filter_expression = document.getElementById('filter_expression').value;
            const catalogs = {};
            document.querySelectorAll('input[name="catalogs"]').forEach(cb => {
                catalogs[cb.value] = cb.checked;
            });

            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = "";

            try {
                const response = await fetch('http://127.0.0.1:5000/api/list_objects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude, longitude, date, local_time, timezone, filter_expression, catalogs })
                });

                if (!response.ok) throw new Error('Failed to fetch data');
                
                const data = await response.json();
                populateTable(data);

            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Failed to load objects. Please try again.");
            }
        }

        function populateTable(data) {
            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = "";  // Clear existing rows

            data.forEach(obj => {
                const row = document.createElement('tr');
                
                // Fill row with object data
                row.innerHTML = `
                    <td>${obj.Name}</td><td>${obj.RA}</td><td>${obj.Dec}</td><td>${obj["Transit Time"]}</td>
                    <td>${obj["Relative TT"]}</td><td>${obj["Before/After"]}</td><td>${obj.Altitude}</td>
                    <td>${obj.Azimuth}</td><td>${obj["Alt Name"]}</td><td>${obj.Type}</td>
                    <td>${obj.Magnitude}</td><td>${obj.Info}</td><td>${obj.Catalog}</td>
                `;

                // Add double-click event listener to open AstroBin page
                row.addEventListener('dblclick', () => {
                    const objectName = obj.Name.replace(/\s+/g, '');  // Replace spaces with '+'
                    const astrobinUrl = `https://www.astrobin.com/search/?q=${encodeURIComponent(objectName)}`;
                    window.open(astrobinUrl, '_blank');
                });

                tableBody.appendChild(row);
            });
        }

        let sortDirection = 1;
        function sortTableByColumn(columnIndex) {
            const tableBody = document.getElementById('resultsTableBody');
            const rows = Array.from(tableBody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                const cellA = a.cells[columnIndex].innerText;
                const cellB = b.cells[columnIndex].innerText;

                if (!isNaN(cellA) && !isNaN(cellB)) {
                    return (cellA - cellB) * sortDirection;
                } else {
                    return cellA.localeCompare(cellB) * sortDirection;
                }
            });

            sortDirection = -sortDirection;
            rows.forEach(row => tableBody.appendChild(row));
        }

        function addResizers() {
            document.querySelectorAll('#resultsTable th').forEach((th, index) => {
                const resizer = document.createElement('div');
                resizer.classList.add('resizer');
                th.appendChild(resizer);
                resizer.addEventListener('mousedown', e => initResize(e, index));
            });
        }

        function initResize(e, index) {
            const startX = e.pageX;
            const startWidth = e.target.parentElement.offsetWidth;

            function resizeColumn(e) {
                const newWidth = Math.max(startWidth + (e.pageX - startX), 50);
                document.querySelectorAll(`#resultsTable th:nth-child(${index + 1}), #resultsTable td:nth-child(${index + 1})`)
                    .forEach(cell => {
                        cell.style.width = `${newWidth}px`;
                    });
            }

            function stopResize() {
                document.removeEventListener('mousemove', resizeColumn);
                document.removeEventListener('mouseup', stopResize);
            }

            document.addEventListener('mousemove', resizeColumn);
            document.addEventListener('mouseup', stopResize);
        }
    </script>
</head>
<body>
    <div id="resultsContainer">
        <h1>TonightSky v1.0</h1>
        <form onsubmit="event.preventDefault(); listObjects();" id="topForm">
            <!-- First Row: Latitude, Longitude, Timezone -->
            <div class="form-row">
                <label class="label-input">Latitude: <input type="text" id="latitude" value="-33.713611"></label>
                <label class="label-input">Longitude: <input type="text" id="longitude" value="151.090278"></label>
                <label class="label-input">Timezone: <input type="text" id="timezone" value="Australia/Sydney"></label>
            </div>
            
            <!-- Second Row: Date, Local Time, LST -->
            <div class="form-row">
                <label class="label-input">Date: <input type="date" id="date"></label>
                <label class="label-input">Local Time: <input type="time" id="local_time" value="22:00"></label>
                <label class="label-input">LST: <span id="lst_display">00:00:00</span></label>
            </div>
            
            <!-- Third Row: Catalog Filters -->
            <div class="form-row">
                <span class="label">Catalog:</span>
                <label><input type="checkbox" name="catalogs" value="Messier" checked> Messier</label>
                <label><input type="checkbox" name="catalogs" value="NGC"> NGC</label>
                <label><input type="checkbox" name="catalogs" value="IC"> IC</label>
                <label><input type="checkbox" name="catalogs" value="Caldwell"> Caldwell</label>
                <label><input type="checkbox" name="catalogs" value="Abell"> Abell</label>
                <label><input type="checkbox" name="catalogs" value="Sharpless"> Sharpless</label>
            </div>
            
            <!-- Fourth Row: Filter Query -->
            <div class="form-row full-width">
                <label>Filter Query:</label>
                <input type="text" id="filter_expression" class="wide-input" placeholder="e.g., altitude > 30 and magnitude < 6">
            </div>
                
            <!-- Button Row -->
            <div class="button-row">
                <button type="submit">List Objects</button>
            </div>
        </form>

        <!-- Results Table -->
        <table id="resultsTable">
            <thead>
                <tr>
                    <th onclick="sortTableByColumn(0)">Name</th>
                    <th onclick="sortTableByColumn(1)">RA</th>
                    <th onclick="sortTableByColumn(2)">Dec</th>
                    <th onclick="sortTableByColumn(3)">Transit Time</th>
                    <th onclick="sortTableByColumn(4)">Relative TT</th>
                    <th onclick="sortTableByColumn(5)">Before/After</th>
                    <th onclick="sortTableByColumn(6)">Altitude</th>
                    <th onclick="sortTableByColumn(7)">Azimuth</th>
                    <th onclick="sortTableByColumn(8)">Alt Name</th>
                    <th onclick="sortTableByColumn(9)">Type</th>
                    <th onclick="sortTableByColumn(10)">Magnitude</th>
                    <th onclick="sortTableByColumn(11)">Info</th>
                    <th onclick="sortTableByColumn(12)">Catalog</th>
                </tr>
            </thead>
            <tbody id="resultsTableBody">
                <!-- Table rows will be appended here by JavaScript -->
            </tbody>
        </table>
    </div>
</body>
</html>
